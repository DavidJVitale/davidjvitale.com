<div id="leaflet-map-%{id}" class="leaflet-map"></div>
<script>
(() => {
    //Config section
    var leafletCdn = "https://unpkg.com/leaflet@1.5.1/dist/";
    var esriLeafletCdn = "https://unpkg.com/esri-leaflet/dist/";

    var leafletCssId = "leaflet-css-head";
    var leafletJsId = "leaflet-js-head";
    var esriLeafletJsId = "esri-leaflet-js-head";
    var leafletProvidersJsId = "leaflet-providers-js-head";

    var tagInputArg = %{tag_input_arg_json};
    var defaultMapElId = "leaflet-map-%{id}";
    var defaultMapElStyle = "height:300px; margin:25px";
    var mapEl = document.getElementById(defaultMapElId);
    if('div_id' in tagInputArg){
        mapEl.id = tagInputArg['div_id'];
    }
    var mapCssEl = document.createElement("style");
    mapCssEl.innerHTML = "#" + defaultMapElId + "{" + defaultMapElStyle + "}";
    document.head.appendChild(mapCssEl);

    function _createMap(){
        console.log("Creating map %{id}..");
        var map = L.map(mapEl.id).setView([0,0], 3);
        L.tileLayer.provider("OpenStreetMap.Mapnik").addTo(map);
        var leaflet_item_jsons = [%{inside_block_leaflet_objects}];
        for(var i=0; i<leaflet_item_jsons.length; i++){
            var leaflet_item = leaflet_item_jsons[i];
            console.log("Leaflet item #" + i);
            console.log(leaflet_item);
        }
    }

    function createMap(){
        var prevOnLoad;
        if(window.onload){
            prevOnLoad = window.onload;
        }
        window.onload = () => {
            _createMap();
            if(prevOnLoad){
                prevOnLoad();
            }
        }
    }

    //Load the correct elements by adding to head: when ready, call createMap()

    // Add the CSS first, don't worry about when it loads
    var leafletCssEl = document.createElement("link");
    leafletCssEl.id = leafletCssId;
    leafletCssEl.rel = "stylesheet";
    leafletCssEl.href = leafletCdn + "leaflet.css";
    if(!document.getElementById(leafletCssEl.id)){
        document.head.appendChild(leafletCssEl);
    }

    function addToHeadIfNotLoaded(el) {
        //Add the el to the head if it doesn't exist already. If it does, every
        //thing we need is already loaded, so draw the map
        if(!document.getElementById(el.id)){
            document.head.appendChild(el);
        } else {
            createMap();
        }
    }

    // Load the main leaflet.js code, wait for it to load
    var leafletJsEl = document.createElement("script");
    leafletJsEl.id = leafletJsId;
    leafletJsEl.onload = () => {
        //After loaded, load the esri-leaflet.js code, wait for it to load
        var esriEl = document.createElement("script");
        esriEl.id = esriLeafletJsId;
        esriEl.onload = () => {
            //After loaded, add the leaflet-providers <script>, don't wait to load
            provEl = document.createElement("script");
            provEl.id = leafletProvidersJsId;
            provEl.innerHTML = `%{leaflet_providers_js_content}`;
            if(!document.getElementById(provEl.id)){
                 document.head.appendChild(provEl);        
            }
            createMap();
            }
        esriEl.src = esriLeafletCdn + "esri-leaflet.js";
        addToHeadIfNotLoaded(esriEl);
        };
    leafletJsEl.src = leafletCdn + "leaflet.js";
    addToHeadIfNotLoaded(leafletJsEl);
})();
</script>
